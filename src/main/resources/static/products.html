<!DOCTYPE html>
<html lang="it">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Lista Prodotti</title>
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <style>
      table {
         border-collapse: collapse;
         width: 100%;
      }

      th,
      td {
         border: 1px solid #ddd;
         padding: 8px;
         text-align: left;
      }

      th {
         background-color: #f2f2f2;
      }
   </style>
</head>

<body>
   <h1>Lista Prodotti</h1>
   <button id="logoutBtn">Logout</button>
   <table id="productTable">
      <thead>
         <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Prezzo</th>
            <th>Descrizione</th>
         </tr>
      </thead>       
      <tbody></tbody>
   </table>

   <script>
      $(document).ready(function () {
         let token = localStorage.getItem('jwt_token');
         if (!token) {
            window.location.href = '/login.html';
            return;
         }

         $('#logoutBtn').click(function () {
            // Remove token from localStorage
            localStorage.removeItem('jwt_token');

            // Optional: Make a logout request to the server
            $.ajax({
               url: '/api/auth/logout',
               type: 'POST',
               headers: {
                  'Authorization': 'Bearer ' + localStorage.getItem('jwt_token')
               },
               success: function () {
                  console.log('Logout successful');
               },
               error: function (xhr, status, error) {
                  console.error('Logout error:', error);
               },
               complete: function () {
                  // Redirect to login page
                  window.location.href = '/login.html';
               }
            });
         });

         $.ajax({
            url: '/api/products',
            type: 'GET',
            dataType: 'json',
            headers: {
               'Authorization': 'Bearer ' + token
            },
            success: function (data) {
               let tbody = $('#productTable tbody');
               $.each(data, function (i, product) {
                  let row = $('<tr>').append(
                     $('<td>').text(product.id),
                     $('<td>').text(product.pname),
                     $('<td>').text(product.price),
                     $('<td>').text(product.description)
                  );
                  tbody.append(row);
               });
            },
            error: function (xhr, status, error) {
               if (xhr.status === 401) {
                  alert('Sessione scaduta. Effettua nuovamente il login.');
                  localStorage.removeItem('jwt_token');
                  window.location.href = '/login.html';
               } else {
                  console.error('Errore nel caricamento dei prodotti:', error);
                  alert('Si Ã¨ verificato un errore nel caricamento dei prodotti.');
               }
            }
         });
      });
   </script>
</body>

</html>